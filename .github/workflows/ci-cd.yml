name: CI/CD

on:
  pull_request:
    branches: [ "main", "dev" ]
  pull_request_target:
    types: [closed]
    branches: ["dev", "main"]

# PRì´ ë¨¸ì§€ë˜ê¸° ì „ì— ëª¨ë“  ì²´í¬ê°€ í†µê³¼ë˜ì–´ì•¼ í•¨ì„ ëª…ì‹œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ì½”ë“œ ê²€ì¦ ì‘ì—…
  validate:
    if: |
      github.event_name == 'pull_request' && 
      !github.event.pull_request.merged
    name: Validate Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Check code style
        run: ./gradlew spotlessCheck
        
      - name: Run Android Lint
        run: ./gradlew lint
        
      - name: Upload Lint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-report
          path: app/build/reports/lint-results-debug.html

  # PR ê²€ì¦ìš© í…ŒìŠ¤íŠ¸ ì‘ì—…
  test-and-build:
    name: Test and Build
    needs: [validate]
    if: |
      github.event_name == 'pull_request' && 
      !github.event.pull_request.merged
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest
        
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: app/build/reports/tests/testDebugUnitTest/

  # ë°°í¬ìš© ë¹Œë“œ ì‘ì—…
  build-for-deploy:
    name: Build for Deploy
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request_target' && 
      github.event.pull_request.merged == true
    outputs:
      build_type: ${{ github.base_ref == 'main' && 'release' || 'debug' }}
      timestamp: ${{ steps.set-timestamp.outputs.value }}
      artifact_name: ${{ steps.set-artifact-name.outputs.value }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest
        
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-deploy
          path: app/build/reports/tests/testDebugUnitTest/

      - name: Set Timestamp
        id: set-timestamp
        env:
          TZ: 'Asia/Seoul'
        run: echo "value=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: Set Artifact Name
        id: set-artifact-name
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "value=release-build" >> $GITHUB_OUTPUT
          else
            echo "value=beta-build" >> $GITHUB_OUTPUT
          fi

      - name: Build APK
        env:
          VERSION_CODE: ${{ vars.VERSION_CODE }}
          BUILD_TIMESTAMP: ${{ steps.set-timestamp.outputs.value }}
          BETA_VERSION: ${{ needs.version-management.outputs.version }}
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            ./gradlew assembleRelease -Prelease
          else
            ./gradlew assembleDebug
          fi

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set-artifact-name.outputs.value }}
          path: |
            app/build/outputs/apk/**/*.apk
            app/build/outputs/apk/**/output-metadata.json
          retention-days: 1

  # ë²„ì „ ê´€ë¦¬ ì‘ì—… (dev ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œì—ë§Œ)
  version-management:
    name: Version Management
    runs-on: ubuntu-latest
    needs: [build-for-deploy]
    if: |
      github.event_name == 'pull_request_target' && 
      github.event.pull_request.merged == true && 
      github.base_ref == 'dev'
    permissions:
      contents: write
      actions: write
    outputs:
      version_code: ${{ vars.VERSION_CODE }}
      beta_tag: ${{ steps.create-beta-tag.outputs.tag }}
      has_previous_beta: ${{ steps.create-beta-tag.outputs.has_previous_beta }}
      previous_beta: ${{ steps.create-beta-tag.outputs.previous_beta }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          token: ${{ secrets.ADMIN_TOKEN }}

      - name: Update Version Code
        id: version-update
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        with:
          github-token: ${{ secrets.ADMIN_TOKEN }}
          script: |
            const currentVersion = parseInt('${{ vars.VERSION_CODE }}') || 0;
            const newVersion = currentVersion + 1;
            
            await github.rest.actions.updateRepoVariable({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'VERSION_CODE',
              value: newVersion.toString()
            });
            
            console.log(`Version Code updated: ${currentVersion} â†’ ${newVersion}`);
            core.setOutput('new_version', newVersion.toString());

      - name: Create Beta Tag
        id: create-beta-tag
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # ìµœì‹  ì •ì‹ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ê°€ì ¸ì˜¤ê¸° (betaê°€ ì•„ë‹Œ íƒœê·¸ ì¤‘ ê°€ì¥ ìµœì‹ )
          latest_release=$(git tag -l "v*" | grep -v "beta" | sort -V | tail -n 1)
          
          # ìµœì‹  ë² íƒ€ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
          latest_beta=$(git tag -l "v*-beta*" | sort -V | tail -n 1)
          
          # PR ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ íƒ€ì… ì¶”ì¶œ
          branch_name="${{ github.head_ref }}"
          
          # ê¸°ë³¸ê°’ ì„¤ì •
          if [ -z "$latest_release" ]; then
            major=1
            minor=0
            patch=0
          else
            version=${latest_release#v}
            IFS='.' read -r major minor patch <<< "$version"
            
            # ìµœì‹  ë² íƒ€ ë²„ì „ ë¶„ì„
            if [ ! -z "$latest_beta" ]; then
              beta_version=$(echo $latest_beta | sed 's/v\([0-9]*\.[0-9]*\.[0-9]*\).*/\1/')
              IFS='.' read -r beta_major beta_minor beta_patch <<< "$beta_version"
              
              # ë² íƒ€ ë²„ì „ì´ ì´ë¯¸ minor ë²„ì „ì´ ì˜¬ë¼ê°„ ìƒíƒœì¸ì§€ í™•ì¸
              if [ "$beta_minor" -gt "$minor" ]; then
                # minor ë²„ì „ì´ ì´ë¯¸ ì˜¬ë¼ê°„ ìƒíƒœë©´ í•´ë‹¹ ë²„ì „ ìœ ì§€
                major=$beta_major
                minor=$beta_minor
                patch=$beta_patch
                echo "Using existing beta version: v$major.$minor.$patch"
              else
                # ë¸Œëœì¹˜ íƒ€ì…ì— ë”°ë¼ ë²„ì „ ê²°ì •
                if [[ "$branch_name" =~ ^feat/ ]]; then
                  minor=$((minor + 1))
                  patch=0
                else
                  patch=$((patch + 1))
                fi
              fi
            else
              # ë¸Œëœì¹˜ íƒ€ì…ì— ë”°ë¼ ë²„ì „ ê²°ì •
              if [[ "$branch_name" =~ ^feat/ ]]; then
                minor=$((minor + 1))
                patch=0
              else
                patch=$((patch + 1))
              fi
            fi
          fi
          
          next_version="$major.$minor.$patch"
          
          # ì´ì „ ë² íƒ€ íƒœê·¸ ì°¾ê¸° (ê°™ì€ ë²„ì „ì˜ ê°€ì¥ ìµœì‹  ë² íƒ€)
          previous_beta=$(git tag -l "v${next_version}-beta*" | sort -V | tail -n 1)
          
          # ìƒˆë¡œìš´ ë² íƒ€ íƒœê·¸ ìƒì„±
          beta_tag="v$next_version-beta.${{ needs.build-for-deploy.outputs.timestamp }}"
          echo "tag=$beta_tag" >> $GITHUB_OUTPUT
          echo "version=$next_version" >> $GITHUB_OUTPUT
          echo "has_previous_beta=false" >> $GITHUB_OUTPUT
          
          if [ ! -z "$previous_beta" ]; then
            echo "has_previous_beta=true" >> $GITHUB_OUTPUT
            echo "previous_beta=$previous_beta" >> $GITHUB_OUTPUT
            echo "ì´ì „ ë² íƒ€ íƒœê·¸ ë°œê²¬: $previous_beta (ë¦´ë¦¬ì¦ˆ ì‘ì—…ì—ì„œ ì‚­ì œ ì˜ˆì •)"
          fi
          
          echo "Creating beta tag: $beta_tag (based on $latest_release)"
          git tag -a "$beta_tag" -m "Beta release $beta_tag"
          git push origin "$beta_tag"

  # main ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„±
  create-release-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: [build-for-deploy]
    if: |
      github.event_name == 'pull_request_target' && 
      github.event.pull_request.merged == true && 
      github.base_ref == 'main'
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.create-release-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          token: ${{ secrets.ADMIN_TOKEN }}

      - name: Create Release Tag
        id: create-release-tag
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          latest_beta=$(git tag -l "v*-beta*" | sort -V | tail -n 1)
          if [ -z "$latest_beta" ]; then
            echo "No beta tag found"
            exit 1
          fi
          
          version=$(echo $latest_beta | sed 's/^v\(.*\)-beta\..*/\1/')
          release_tag="v$version"
          echo "tag=$release_tag" >> $GITHUB_OUTPUT
          
          echo "Creating release tag: $release_tag"
          git tag -a "$release_tag" -m "Release $release_tag"
          git push origin "$release_tag"

  # ë² íƒ€ ë¦´ë¦¬ì¦ˆ ìƒì„± (dev ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œ)
  create-beta-release:
    name: Create Beta Release
    runs-on: ubuntu-latest
    needs: [build-for-deploy, version-management]
    if: |
      github.event_name == 'pull_request_target' && 
      github.event.pull_request.merged == true && 
      github.base_ref == 'dev'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.version-management.outputs.beta_tag }}
          fetch-depth: 0
          token: ${{ secrets.ADMIN_TOKEN }}
        
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-for-deploy.outputs.artifact_name }}
          path: artifacts

      - name: Get Previous Beta Release Notes
        id: get-previous-notes
        run: |
          has_previous="${{ needs.version-management.outputs.has_previous_beta }}"
          previous_beta="${{ needs.version-management.outputs.previous_beta }}"
          
          echo "has_previous_beta: $has_previous"
          echo "previous_beta: $previous_beta"
          
          if [[ "$has_previous" == "true" ]] && [[ ! -z "$previous_beta" ]]; then
            echo "ì´ì „ ë² íƒ€ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ê°€ì ¸ì˜¤ëŠ” ì¤‘: $previous_beta"
            
            # GitHub APIë¥¼ í†µí•´ ì´ì „ ë¦´ë¦¬ì¦ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            api_response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
              -H "Authorization: token ${{ secrets.ADMIN_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/$previous_beta")
            
            http_code=$(echo "$api_response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            response_body=$(echo "$api_response" | sed -e 's/HTTPSTATUS:.*//g')
            
            echo "API HTTP ìƒíƒœ ì½”ë“œ: $http_code"
            
            if [ "$http_code" = "200" ]; then
              previous_notes=$(echo "$response_body" | jq -r '.body // empty')
              release_id=$(echo "$response_body" | jq -r '.id // empty')
              
              echo "ë¦´ë¦¬ì¦ˆ ID: $release_id"
              echo "ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ê¸¸ì´: ${#previous_notes}"
              
              # ë¦´ë¦¬ì¦ˆ IDë¥¼ ì €ì¥ (ì‚­ì œìš©)
              echo "release_id=$release_id" >> $GITHUB_OUTPUT
              
              if [ ! -z "$previous_notes" ] && [ "$previous_notes" != "null" ] && [ "$previous_notes" != "empty" ]; then
                # ë³€ê²½ ì‚¬í•­ ë¶€ë¶„ë§Œ ì¶”ì¶œ (í—¤ë” ì œì™¸)
                changes=$(echo "$previous_notes" | sed -n '/^- /p' | head -20)
                if [ ! -z "$changes" ]; then
                  echo "previous_changes<<EOF" >> $GITHUB_OUTPUT
                  echo "$changes" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
                  echo "has_changes=true" >> $GITHUB_OUTPUT
                  echo "ì´ì „ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ (${#changes} ë¬¸ì)"
                else
                  echo "has_changes=false" >> $GITHUB_OUTPUT
                  echo "ì´ì „ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŒ"
                fi
              else
                echo "has_changes=false" >> $GITHUB_OUTPUT
                echo "ì´ì „ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ê°€ ë¹„ì–´ìˆìŒ"
              fi
            elif [ "$http_code" = "404" ]; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "release_id=" >> $GITHUB_OUTPUT
              echo "ì´ì „ ë² íƒ€ ë¦´ë¦¬ì¦ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ (404)"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "release_id=" >> $GITHUB_OUTPUT
              echo "API í˜¸ì¶œ ì‹¤íŒ¨: HTTP $http_code"
              echo "ì‘ë‹µ: $response_body"
              
              # API ì˜¤ë¥˜ ì‹œ ìˆ˜ë™ ì²˜ë¦¬ ê°€ì´ë“œ ì œê³µ
              if [[ "$http_code" =~ ^5[0-9][0-9]$ ]]; then
                echo ""
                echo "ğŸš¨ GitHub API ì„œë²„ ì˜¤ë¥˜ (HTTP $http_code) ê°ì§€!"
                echo "Re-run jobì„ í•´ë„ ë™ì¼í•œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤."
                echo ""
                echo "ğŸ“‹ ìˆ˜ë™ ì²˜ë¦¬ ë°©ë²•:"
                echo "1. GitHub ë¦´ë¦¬ì¦ˆ í˜ì´ì§€ì—ì„œ ì´ì „ ë² íƒ€ ë¦´ë¦¬ì¦ˆ í™•ì¸:"
                echo "   https://github.com/${{ github.repository }}/releases"
                echo ""
                echo "2. ì´ì „ ë² íƒ€ ë¦´ë¦¬ì¦ˆê°€ ìˆë‹¤ë©´ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•˜ê±°ë‚˜ Draft ì²˜ë¦¬"
                echo ""
                echo "3. ë˜ëŠ” Git ëª…ë ¹ì–´ë¡œ ì´ì „ ë² íƒ€ íƒœê·¸ ì‚­ì œ:"
                echo "   git tag -d $previous_beta"
                echo "   git push origin :refs/tags/$previous_beta"
                echo ""
                echo "4. ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰ ë˜ëŠ” ìƒˆë¡œìš´ PR ìƒì„±"
                echo ""
              elif [ "$http_code" = "403" ]; then
                echo ""
                echo "ğŸ”’ GitHub API ê¶Œí•œ ì˜¤ë¥˜ (HTTP 403)"
                echo "í† í° ê¶Œí•œì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ì¬ì‹œë„í•˜ì„¸ìš”."
                echo ""
              elif [ "$http_code" = "429" ]; then
                echo ""
                echo "â° GitHub API ìš”ì²­ ì œí•œ (HTTP 429)"
                echo "ì ì‹œ í›„ Re-run jobì„ ì‹œë„í•˜ì„¸ìš”."
                echo ""
              fi
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "release_id=" >> $GITHUB_OUTPUT
            echo "ì´ì „ ë² íƒ€ ë¦´ë¦¬ì¦ˆê°€ ì—†ìŒ"
          fi

      - name: Delete Previous Beta Release
        run: |
          has_previous="${{ needs.version-management.outputs.has_previous_beta }}"
          previous_beta="${{ needs.version-management.outputs.previous_beta }}"
          release_id="${{ steps.get-previous-notes.outputs.release_id }}"
          
          if [[ "$has_previous" == "true" ]] && [[ ! -z "$previous_beta" ]]; then
            echo "ì´ì „ ë² íƒ€ ë¦´ë¦¬ì¦ˆ ì‚­ì œ ì¤‘: $previous_beta"
            echo "ì‚¬ìš©í•  ë¦´ë¦¬ì¦ˆ ID: $release_id"
            
            # ì´ì „ ìŠ¤í…ì—ì„œ ê°€ì ¸ì˜¨ ë¦´ë¦¬ì¦ˆ ID ì‚¬ìš©
            if [ ! -z "$release_id" ] && [ "$release_id" != "null" ] && [ "$release_id" != "empty" ]; then
              echo "ë¦´ë¦¬ì¦ˆ ID $release_id ì‚­ì œ ì‹œë„ ì¤‘..."
              
              delete_response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
                -X DELETE \
                -H "Authorization: token ${{ secrets.ADMIN_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$release_id")
              
              delete_http_code=$(echo "$delete_response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
              delete_body=$(echo "$delete_response" | sed -e 's/HTTPSTATUS:.*//g')
              
              echo "ì‚­ì œ API HTTP ìƒíƒœ ì½”ë“œ: $delete_http_code"
              
              if [ "$delete_http_code" = "204" ]; then
                echo "ì´ì „ ë² íƒ€ ë¦´ë¦¬ì¦ˆ ì‚­ì œ ì™„ë£Œ: $release_id"
                
                # ë¦´ë¦¬ì¦ˆ ì‚­ì œ ì„±ê³µ í›„ íƒœê·¸ë„ ì‚­ì œ
                echo "ì´ì „ ë² íƒ€ íƒœê·¸ ì‚­ì œ ì¤‘: $previous_beta"
                git tag -d "$previous_beta" 2>/dev/null || echo "ë¡œì»¬ íƒœê·¸ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚­ì œë¨"
                git push origin ":refs/tags/$previous_beta" 2>/dev/null || echo "ì›ê²© íƒœê·¸ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚­ì œë¨"
                echo "ì´ì „ ë² íƒ€ íƒœê·¸ ì‚­ì œ ì™„ë£Œ: $previous_beta"
              else
                echo "ë¦´ë¦¬ì¦ˆ ì‚­ì œ ì‹¤íŒ¨: HTTP $delete_http_code"
                echo "ì‘ë‹µ: $delete_body"
                
                # ì„œë²„ ì˜¤ë¥˜ ì‹œ ìˆ˜ë™ ì²˜ë¦¬ ê°€ì´ë“œ ì œê³µ
                if [[ "$delete_http_code" =~ ^5[0-9][0-9]$ ]]; then
                  echo ""
                  echo "ğŸš¨ GitHub API ì„œë²„ ì˜¤ë¥˜ (HTTP $delete_http_code) ê°ì§€!"
                  echo "Re-run jobì„ í•´ë„ ë™ì¼í•œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤."
                  echo ""
                  echo "ğŸ“‹ ìˆ˜ë™ ì²˜ë¦¬ ë°©ë²•:"
                  echo "1. GitHub ë¦´ë¦¬ì¦ˆ í˜ì´ì§€ì—ì„œ ì§ì ‘ ì‚­ì œ:"
                  echo "   https://github.com/${{ github.repository }}/releases/tag/$previous_beta"
                  echo ""
                  echo "2. ë˜ëŠ” Git ëª…ë ¹ì–´ë¡œ íƒœê·¸ ì‚­ì œ:"
                  echo "   git tag -d $previous_beta"
                  echo "   git push origin :refs/tags/$previous_beta"
                  echo ""
                  echo "3. ê¸‰í•œ ê²½ìš° ë¦´ë¦¬ì¦ˆë¥¼ Draft ìƒíƒœë¡œ ìˆ˜ë™ ë³€ê²½"
                  echo ""
                  echo "âš ï¸  ì„œë²„ ì˜¤ë¥˜ê°€ í•´ê²°ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤."
                  echo ""
                elif [ "$delete_http_code" = "403" ]; then
                  echo ""
                  echo "ğŸ”’ GitHub API ê¶Œí•œ ì˜¤ë¥˜ (HTTP 403)"
                  echo "í† í° ê¶Œí•œì„ í™•ì¸í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë¦´ë¦¬ì¦ˆë¥¼ ì‚­ì œí•˜ì„¸ìš”:"
                  echo "   https://github.com/${{ github.repository }}/releases/tag/$previous_beta"
                  echo ""
                elif [ "$delete_http_code" = "429" ]; then
                  echo ""
                  echo "â° GitHub API ìš”ì²­ ì œí•œ (HTTP 429)"
                  echo "ì ì‹œ í›„ Re-run jobì„ ì‹œë„í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ì„¸ìš”."
                  echo ""
                else
                  # ëŒ€ì•ˆ: ë¦´ë¦¬ì¦ˆë¥¼ Draftë¡œ ë³€ê²½
                  echo "ëŒ€ì•ˆìœ¼ë¡œ ë¦´ë¦¬ì¦ˆë¥¼ Draft ìƒíƒœë¡œ ë³€ê²½ ì‹œë„..."
                  draft_response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
                    -X PATCH \
                    -H "Authorization: token ${{ secrets.ADMIN_TOKEN }}" \
                    -H "Content-Type: application/json" \
                    -d '{"draft": true}' \
                    "https://api.github.com/repos/${{ github.repository }}/releases/$release_id")
                  
                  draft_http_code=$(echo "$draft_response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
                  
                  if [ "$draft_http_code" = "200" ]; then
                    echo "ë¦´ë¦¬ì¦ˆë¥¼ Draft ìƒíƒœë¡œ ë³€ê²½ ì™„ë£Œ"
                    
                    # Draft ì²˜ë¦¬ ì„±ê³µ í›„ íƒœê·¸ë„ ì‚­ì œ
                    echo "ì´ì „ ë² íƒ€ íƒœê·¸ ì‚­ì œ ì¤‘: $previous_beta"
                    git tag -d "$previous_beta" 2>/dev/null || echo "ë¡œì»¬ íƒœê·¸ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚­ì œë¨"
                    git push origin ":refs/tags/$previous_beta" 2>/dev/null || echo "ì›ê²© íƒœê·¸ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚­ì œë¨"
                    echo "ì´ì „ ë² íƒ€ íƒœê·¸ ì‚­ì œ ì™„ë£Œ: $previous_beta"
                  elif [[ "$draft_http_code" =~ ^5[0-9][0-9]$ ]]; then
                    echo "Draft ë³€ê²½ë„ ì„œë²„ ì˜¤ë¥˜ë¡œ ì‹¤íŒ¨: HTTP $draft_http_code"
                    echo ""
                    echo "ğŸš¨ GitHub API ì„œë²„ì— ë¬¸ì œê°€ ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤."
                    echo "ğŸ“‹ ìˆ˜ë™ìœ¼ë¡œ GitHub ì›¹ì‚¬ì´íŠ¸ì—ì„œ ë¦´ë¦¬ì¦ˆë¥¼ Draft ì²˜ë¦¬í•˜ì„¸ìš”:"
                    echo "   https://github.com/${{ github.repository }}/releases/tag/$previous_beta"
                    echo ""
                  else
                    echo "Draft ë³€ê²½ë„ ì‹¤íŒ¨: HTTP $draft_http_code"
                  fi
                fi
              fi
            else
              echo "ìœ íš¨í•œ ë¦´ë¦¬ì¦ˆ IDê°€ ì—†ìŒ - ë¦´ë¦¬ì¦ˆëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŒ"
              echo "ì´ì „ ìŠ¤í…ì—ì„œ ë¦´ë¦¬ì¦ˆë¥¼ ì°¾ì§€ ëª»í–ˆê±°ë‚˜ ì´ë¯¸ ì‚­ì œë¨"
              
              # ë¦´ë¦¬ì¦ˆëŠ” ì—†ì§€ë§Œ íƒœê·¸ëŠ” ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ íƒœê·¸ë§Œ ì‚­ì œ ì‹œë„
              echo "ì´ì „ ë² íƒ€ íƒœê·¸ë§Œ ì‚­ì œ ì‹œë„: $previous_beta"
              git tag -d "$previous_beta" 2>/dev/null || echo "ë¡œì»¬ íƒœê·¸ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚­ì œë¨"
              git push origin ":refs/tags/$previous_beta" 2>/dev/null || echo "ì›ê²© íƒœê·¸ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚­ì œë¨"
              echo "ì´ì „ ë² íƒ€ íƒœê·¸ ì‚­ì œ ì‹œë„ ì™„ë£Œ: $previous_beta"
            fi
          else
            echo "ì‚­ì œí•  ì´ì „ ë² íƒ€ ë¦´ë¦¬ì¦ˆê°€ ì—†ìŒ"
          fi

      - name: Generate Beta Release Notes
        run: |
          BETA_TAG="${{ needs.version-management.outputs.beta_tag }}"
          VERSION="${BETA_TAG#v}"
          
          echo "## ë² íƒ€ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "ë²„ì „: $VERSION" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # ìƒˆë¡œìš´ ë³€ê²½ ì‚¬í•­ ì¶”ê°€
          echo "### ìµœì‹  ë³€ê²½ ì‚¬í•­" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log -1 --pretty=format:"- %s" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # ì´ì „ ë² íƒ€ ë¦´ë¦¬ì¦ˆì˜ ë³€ê²½ ì‚¬í•­ ì¶”ê°€ (ìˆëŠ” ê²½ìš°)
          if [[ "${{ steps.get-previous-notes.outputs.has_changes }}" == "true" ]]; then
            echo "### ì´ì „ ë³€ê²½ ì‚¬í•­" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "${{ steps.get-previous-notes.outputs.previous_changes }}" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

      - name: Create Beta Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        with:
          files: |
            artifacts/**/*.apk
            artifacts/**/output-metadata.json
          tag_name: ${{ needs.version-management.outputs.beta_tag }}
          name: "Beta Release ${{ needs.version-management.outputs.beta_tag }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: true

  # ì •ì‹ ë¦´ë¦¬ì¦ˆ ìƒì„± (main ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œ)
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-for-deploy, create-release-tag]
    if: |
      github.event_name == 'pull_request_target' && 
      github.event.pull_request.merged == true && 
      github.base_ref == 'main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release-tag.outputs.release_tag }}
          fetch-depth: 0
          token: ${{ secrets.ADMIN_TOKEN }}
        
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-for-deploy.outputs.artifact_name }}
          path: artifacts

      - name: Generate Release Notes
        run: |
          RELEASE_TAG="${{ needs.create-release-tag.outputs.release_tag }}"
          VERSION="${RELEASE_TAG#v}"
          
          echo "## ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "ë²„ì „: $VERSION" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$previous_tag" ]; then
            git log --pretty=format:"- %s" >> CHANGELOG.md
          else
            git log --pretty=format:"- %s" ${previous_tag}..HEAD >> CHANGELOG.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        with:
          files: |
            artifacts/**/*.apk
            artifacts/**/output-metadata.json
          tag_name: ${{ needs.create-release-tag.outputs.release_tag }}
          name: "Release ${{ needs.create-release-tag.outputs.release_tag }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: false 