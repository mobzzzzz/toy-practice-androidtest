name: Sync Main to Dev

on:
  # main ë¸Œëžœì¹˜ì— pushë  ë•Œ (ë¦´ë¦¬ì¦ˆ íƒœê·¸ í¬í•¨)
  push:
    branches: [main]
    tags: ['v*']
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes'
        required: false
        default: false
        type: boolean

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: "sync-main-to-dev"
  cancel-in-progress: false

jobs:
  sync-branches:
    name: Sync Main to Dev
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # ADMIN_TOKEN ì‚¬ìš©ìœ¼ë¡œ branch protection ìš°íšŒ
          token: ${{ secrets.ADMIN_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Sync Main to Dev
        run: |
          echo "ðŸ”„ Starting main â†’ dev synchronization..."
          
          # ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
          git fetch origin
          
          # dev ë¸Œëžœì¹˜ë¡œ ì „í™˜
          git checkout dev
          git pull origin dev
          
          # mainì˜ ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ í™•ì¸
          if git merge-base --is-ancestor origin/main dev; then
            echo "âœ… Dev is already up to date with main"
            if [ "${{ github.event.inputs.force_sync }}" != "true" ]; then
              echo "No sync needed. Exiting."
              exit 0
            fi
          fi
          
          # mainì˜ ë³€ê²½ì‚¬í•­ì„ devì— ë³‘í•©
          echo "ðŸ“¥ Merging main into dev..."
          git merge origin/main --no-edit
          
          # ì¶©ëŒì´ ë°œìƒí•œ ê²½ìš° ì²˜ë¦¬
          if [ $? -ne 0 ]; then
            echo "âŒ Merge conflict detected!"
            echo "Creating PR for manual conflict resolution..."
            
            # ì¶©ëŒ í•´ê²°ì„ ìœ„í•œ ë¸Œëžœì¹˜ ìƒì„±
            conflict_branch="sync/main-to-dev-$(date +%Y%m%d%H%M%S)"
            git checkout -b $conflict_branch
            git add .
            git commit -m "conflict: main â†’ dev ë™ê¸°í™” ì¤‘ ì¶©ëŒ ë°œìƒ - ìˆ˜ë™ í•´ê²° í•„ìš”"
            git push origin $conflict_branch
            
            # PR ìƒì„±
            gh pr create \
              --base dev \
              --head $conflict_branch \
              --title "ðŸ”„ [ìžë™] Main â†’ Dev ë™ê¸°í™” (ì¶©ëŒ í•´ê²° í•„ìš”)" \
              --body "Main ë¸Œëžœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ devì— ë™ê¸°í™”í•˜ëŠ” ì¤‘ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì¶©ëŒì„ í•´ê²°í•´ì£¼ì„¸ìš”." \
              --label "sync,conflict"
            
            exit 1
          fi
          
          # ì„±ê³µì ìœ¼ë¡œ ë³‘í•©ëœ ê²½ìš° push
          echo "âœ… Successfully merged main into dev"
          git push origin dev
          
          echo "ðŸŽ‰ Synchronization completed!"

      - name: Create Sync Summary
        if: success()
        run: |
          echo "## ðŸ”„ Branch Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "## âŒ Branch Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "Main â†’ Dev ë™ê¸°í™” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "ìˆ˜ë™ìœ¼ë¡œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY 