name: Sync Main to Dev

on:
  # main ë¸Œëžœì¹˜ì— pushë  ë•Œë§Œ (íƒœê·¸ëŠ” ì œì™¸)
  push:
    branches: [main]
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes'
        required: false
        default: false
        type: boolean

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: "sync-main-to-dev"
  cancel-in-progress: false

jobs:
  sync-branches:
    name: Sync Main to Dev
    runs-on: ubuntu-latest
    # íƒœê·¸ pushëŠ” ì œì™¸ (ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„± ì‹œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
    if: github.ref_type != 'tag'
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ADMIN_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Check if sync is needed
        id: check-sync
        run: |
          echo "ðŸ” ë™ê¸°í™” í•„ìš”ì„± í™•ì¸ ì¤‘..."
          
          # íƒœê·¸ ì´ë²¤íŠ¸ì¸ ê²½ìš° ìŠ¤í‚µ
          if [ "${{ github.ref_type }}" == "tag" ]; then
            echo "â­ï¸ íƒœê·¸ ì´ë²¤íŠ¸ëŠ” ìŠ¤í‚µ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)"
            echo "sync_needed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
          git fetch origin
          
          # mainê³¼ devì˜ ì°¨ì´ì  í™•ì¸ ë° ë¶„ì„
          main_commits=$(git rev-list origin/dev..origin/main --count)
          dev_commits=$(git rev-list origin/main..origin/dev --count)
          
          echo "ðŸ“Š ë¸Œëžœì¹˜ ìƒíƒœ ë¶„ì„:"
          echo "- mainì—ë§Œ ìžˆëŠ” ì»¤ë°‹: $main_commitsê°œ"
          echo "- devì—ë§Œ ìžˆëŠ” ì»¤ë°‹: $dev_commitsê°œ"
          
          if [ "$main_commits" -eq 0 ]; then
            echo "âœ… dev ë¸Œëžœì¹˜ê°€ ì´ë¯¸ ìµœì‹  ìƒíƒœìž…ë‹ˆë‹¤"
            if [ "${{ github.event.inputs.force_sync }}" != "true" ]; then
              echo "sync_needed=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "ðŸ”„ ê°•ì œ ë™ê¸°í™” ìš”ì²­ë¨"
              echo "sync_needed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "ðŸ“¥ ë™ê¸°í™” í•„ìš”: mainì— $main_commitsê°œì˜ ìƒˆë¡œìš´ ì»¤ë°‹ì´ ìžˆìŒ"
            if [ "$dev_commits" -gt 0 ]; then
              echo "âš ï¸ ì£¼ì˜: devì—ë„ $dev_commitsê°œì˜ ë…ë¦½ì ì¸ ì»¤ë°‹ì´ ìžˆìŒ (ì¶©ëŒ ê°€ëŠ¥ì„±)"
            fi
            echo "sync_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Attempt automatic sync
        if: steps.check-sync.outputs.sync_needed == 'true'
        id: auto-sync
        run: |
          echo "ðŸ”„ main â†’ dev ìžë™ ë™ê¸°í™” ì‹œìž‘..."
          echo "ðŸ“‹ ì „ëžµ: ê¹”ë”í•œ ížˆìŠ¤í† ë¦¬ ìœ ì§€ (ë¶ˆí•„ìš”í•œ merge ì»¤ë°‹ ë°©ì§€)"
          
          # dev ë¸Œëžœì¹˜ë¡œ ì „í™˜
          git checkout dev
          git reset --hard origin/dev
          
          # Fast-forward ê°€ëŠ¥í•œì§€ ì •í™•ížˆ í™•ì¸
          dev_commits=$(git rev-list origin/main..origin/dev --count)
          
          if [ "$dev_commits" -eq 0 ]; then
            echo "âœ… Fast-forward ë³‘í•© ê°€ëŠ¥ (devì— ë…ë¦½ì ì¸ ì»¤ë°‹ ì—†ìŒ)"
            # Fast-forward merge (ì»¤ë°‹ ê¸°ë¡ ì—†ìŒ)
            if git merge origin/main --ff-only; then
              echo "âœ… Fast-forward ë³‘í•© ì„±ê³µ (ì»¤ë°‹ ê¸°ë¡ ì—†ìŒ)"
              git push origin dev
              echo "ðŸŽ‰ ë™ê¸°í™” ì™„ë£Œ!"
              echo "sync_success=true" >> $GITHUB_OUTPUT
              echo "merge_type=fast-forward" >> $GITHUB_OUTPUT
            else
              echo "âŒ Fast-forward ì‹¤íŒ¨ (ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜)"
              echo "sync_success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Fast-forward ë¶ˆê°€ëŠ¥ - devì— $dev_commitsê°œì˜ ë…ë¦½ì ì¸ ì»¤ë°‹ ì¡´ìž¬"
            echo "ðŸ”€ ì¼ë°˜ ë³‘í•© ì‹œë„ (merge ì»¤ë°‹ ìƒì„±ë¨)"
            # ì¼ë°˜ merge ì‹œë„ (ì¶©ëŒ ê°€ëŠ¥ì„± ìžˆìŒ)
            if git merge origin/main --no-edit; then
              echo "âœ… ì¼ë°˜ ë³‘í•© ì„±ê³µ"
              git push origin dev
              echo "ðŸŽ‰ ë™ê¸°í™” ì™„ë£Œ!"
              echo "sync_success=true" >> $GITHUB_OUTPUT
              echo "merge_type=merge" >> $GITHUB_OUTPUT
            else
              echo "âŒ ì¶©ëŒë¡œ ì¸í•œ ë³‘í•© ì‹¤íŒ¨"
              echo "sync_success=false" >> $GITHUB_OUTPUT
              
              # ì¶©ëŒ ìƒíƒœ ì •ë¦¬
              git merge --abort
              
              # ì¶©ëŒ íŒŒì¼ë“¤ í™•ì¸
              git checkout dev
              git merge origin/main --no-commit --no-ff || true
              conflict_files=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "ì•Œ ìˆ˜ ì—†ìŒ")
              git merge --abort 2>/dev/null || true
              
              echo "conflict_files=$conflict_files" >> $GITHUB_OUTPUT
              echo "merge_type=conflict" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ”„ ë¸Œëžœì¹˜ ë™ê¸°í™” ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "- **ì†ŒìŠ¤**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **íƒ€ê²Ÿ**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ë²¤íŠ¸**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì°¸ì¡°**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.ref_type }}" == "tag" ]; then
            echo "- **ìƒíƒœ**: â­ï¸ ìŠ¤í‚µë¨ (íƒœê·¸ ì´ë²¤íŠ¸ - ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check-sync.outputs.sync_needed }}" == "false" ]; then
            echo "- **ìƒíƒœ**: âœ… ì´ë¯¸ ìµœì‹  ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.auto-sync.outputs.sync_success }}" == "true" ]; then
            if [ "${{ steps.auto-sync.outputs.merge_type }}" == "fast-forward" ]; then
              echo "- **ìƒíƒœ**: âœ… Fast-forward ë™ê¸°í™” ì„±ê³µ (ì»¤ë°‹ ê¸°ë¡ ì—†ìŒ)" >> $GITHUB_STEP_SUMMARY
              echo "- **ë°©ì‹**: ðŸš€ Fast-forward (ê¹”ë”í•œ ížˆìŠ¤í† ë¦¬)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **ìƒíƒœ**: âœ… ì¼ë°˜ ë³‘í•© ë™ê¸°í™” ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
              echo "- **ë°©ì‹**: ðŸ”€ Merge commit (í•„ìš”ì— ì˜í•œ ë³‘í•©)" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${{ steps.auto-sync.outputs.sync_success }}" == "false" ]; then
            echo "- **ìƒíƒœ**: âš ï¸ ì¶©ëŒ ê°ì§€ - ìˆ˜ë™ ë™ê¸°í™” í•„ìš”" >> $GITHUB_STEP_SUMMARY
            echo "- **ì¶©ëŒ íŒŒì¼**: ${{ steps.auto-sync.outputs.conflict_files }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ ìˆ˜ë™ í•´ê²° ë°©ë²•:" >> $GITHUB_STEP_SUMMARY
            echo "1. ë¡œì»¬ì—ì„œ \`git checkout dev\` ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY
            echo "2. \`git merge main\` ì‹¤í–‰í•˜ì—¬ ì¶©ëŒ í™•ì¸" >> $GITHUB_STEP_SUMMARY
            echo "3. **ì¶©ëŒ í•´ê²° ì‹œ main ë¸Œëžœì¹˜ ìš°ì„  ì„ íƒ** (hotfix, release ë³´ì¡´)" >> $GITHUB_STEP_SUMMARY
            echo "   - ì¤‘ìš”í•œ ë³€ê²½ì‚¬í•­: \`git checkout --theirs <íŒŒì¼ëª…>\` (main ì„ íƒ)" >> $GITHUB_STEP_SUMMARY
            echo "   - ê°œë°œ ë³€ê²½ì‚¬í•­: ìˆ˜ë™ìœ¼ë¡œ ë³‘í•©í•˜ì—¬ ë³´ì¡´" >> $GITHUB_STEP_SUMMARY
            echo "4. \`git add .\` ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY
            echo "5. \`git commit\` ì‹¤í–‰ (ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©)" >> $GITHUB_STEP_SUMMARY
            echo "6. \`git push origin dev\` ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ìƒíƒœ**: âŒ ë™ê¸°í™” ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY 