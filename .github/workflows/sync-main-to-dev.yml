name: Sync Main to Dev

on:
  # main ë¸Œëžœì¹˜ì— pushë  ë•Œë§Œ (íƒœê·¸ëŠ” ì œì™¸)
  push:
    branches: [main]
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes'
        required: false
        default: false
        type: boolean

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: "sync-main-to-dev"
  cancel-in-progress: false

jobs:
  sync-branches:
    name: Sync Main to Dev
    runs-on: ubuntu-latest
    # íƒœê·¸ pushëŠ” ì œì™¸ (ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„± ì‹œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
    if: github.ref_type != 'tag'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # ADMIN_TOKEN ì‚¬ìš©ìœ¼ë¡œ branch protection ìš°íšŒ
          token: ${{ secrets.ADMIN_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Check if sync is needed
        id: check-sync
        run: |
          echo "ðŸ” ë™ê¸°í™” í•„ìš”ì„± í™•ì¸ ì¤‘..."
          
          # íƒœê·¸ ì´ë²¤íŠ¸ì¸ ê²½ìš° ìŠ¤í‚µ
          if [ "${{ github.ref_type }}" == "tag" ]; then
            echo "â­ï¸ íƒœê·¸ ì´ë²¤íŠ¸ëŠ” ìŠ¤í‚µ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)"
            echo "sync_needed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
          git fetch origin
          
          # mainê³¼ devì˜ ì°¨ì´ì  í™•ì¸
          if git merge-base --is-ancestor origin/main origin/dev; then
            echo "âœ… dev ë¸Œëžœì¹˜ê°€ ì´ë¯¸ ìµœì‹  ìƒíƒœìž…ë‹ˆë‹¤"
            if [ "${{ github.event.inputs.force_sync }}" != "true" ]; then
              echo "sync_needed=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "ðŸ”„ ê°•ì œ ë™ê¸°í™” ìš”ì²­ë¨"
              echo "sync_needed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "ðŸ“¥ ë™ê¸°í™” í•„ìš”: devê°€ mainë³´ë‹¤ ë’¤ì²˜ì ¸ ìžˆìŒ"
            echo "sync_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Attempt automatic sync
        if: steps.check-sync.outputs.sync_needed == 'true'
        id: auto-sync
        run: |
          echo "ðŸ”„ main â†’ dev ìžë™ ë™ê¸°í™” ì‹œìž‘..."
          
          # dev ë¸Œëžœì¹˜ë¡œ ì „í™˜
          git checkout dev
          git reset --hard origin/dev
          
          # mainì˜ ë³€ê²½ì‚¬í•­ì„ devì— ë³‘í•© ì‹œë„
          if git merge origin/main --no-edit; then
            echo "âœ… ìžë™ ë³‘í•© ì„±ê³µ"
            git push origin dev
            echo "ðŸŽ‰ ë™ê¸°í™” ì™„ë£Œ!"
            echo "sync_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ì¶©ëŒë¡œ ì¸í•œ ìžë™ ë³‘í•© ì‹¤íŒ¨"
            echo "sync_success=false" >> $GITHUB_OUTPUT
            
            # ì¶©ëŒ ìƒíƒœ ì •ë¦¬
            git merge --abort
          fi

      - name: Create conflict resolution PR
        if: steps.check-sync.outputs.sync_needed == 'true' && steps.auto-sync.outputs.sync_success == 'false'
        env:
          GH_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          echo "ðŸ”§ ì¶©ëŒ í•´ê²° PR ìƒì„± ì¤‘..."
          
          # ì¶©ëŒ í•´ê²°ì„ ìœ„í•œ ë¸Œëžœì¹˜ ìƒì„±
          conflict_branch="sync/main-to-dev-$(date +%Y%m%d%H%M%S)"
          git checkout -b $conflict_branch origin/dev
          
          # mainì˜ ë³€ê²½ì‚¬í•­ì„ ë³‘í•©í•˜ë˜ ì¶©ëŒ ìƒíƒœë¡œ ìœ ì§€
          git merge origin/main --no-edit || true
          
          # ì¶©ëŒ íŒŒì¼ë“¤ í™•ì¸
          conflict_files=$(git status --porcelain | grep "^UU\|^AA\|^DD" | cut -c4- || echo "")
          
          # ì¶©ëŒ ìƒíƒœ ê·¸ëŒ€ë¡œ ì»¤ë°‹
          git add .
          git commit -m "conflict: main â†’ dev ë™ê¸°í™” ì¤‘ ì¶©ëŒ ë°œìƒ - ìˆ˜ë™ í•´ê²° í•„ìš”

          íŠ¸ë¦¬ê±°: ${{ github.event_name }} (${{ github.ref }})
          
          ì¶©ëŒ íŒŒì¼ë“¤:
          $conflict_files
          
          í•´ê²° í›„ ì´ PRì„ dev ë¸Œëžœì¹˜ë¡œ ë³‘í•©í•´ì£¼ì„¸ìš”."
          
          git push origin $conflict_branch
          
          # PR ìƒì„±
          cat > pr_body.md << EOF
          ## ðŸ”„ Main â†’ Dev ë™ê¸°í™” ì¶©ëŒ í•´ê²° í•„ìš”
          
          **íŠ¸ë¦¬ê±° ì´ë²¤íŠ¸**: ${{ github.event_name }} (${{ github.ref }})
          
          ë‹¤ìŒ íŒŒì¼ë“¤ì—ì„œ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤:
          
          EOF
          
          if [ -n "$conflict_files" ]; then
            echo "$conflict_files" | while read file; do
              echo "- \`$file\`" >> pr_body.md
            done
          else
            echo "- ì¶©ëŒ íŒŒì¼ ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" >> pr_body.md
          fi
          
          cat >> pr_body.md << EOF
          
          ### í•´ê²° ë°©ë²•:
          1. ê° ì¶©ëŒ íŒŒì¼ì„ ì—´ì–´ì„œ ì¶©ëŒ ë§ˆì»¤ë¥¼ í™•ì¸í•˜ì„¸ìš”
          2. ì ì ˆí•œ ë³€ê²½ì‚¬í•­ì„ ì„ íƒí•˜ê±°ë‚˜ ë³‘í•©í•˜ì„¸ìš”  
          3. \`git add <íŒŒì¼ëª…>\`ìœ¼ë¡œ í•´ê²°ëœ íŒŒì¼ì„ ì¶”ê°€í•˜ì„¸ìš”
          4. \`git commit\`ìœ¼ë¡œ ë³‘í•©ì„ ì™„ë£Œí•˜ì„¸ìš”
          5. ì´ PRì„ dev ë¸Œëžœì¹˜ë¡œ ë³‘í•©í•˜ì„¸ìš”
          EOF
          
          gh pr create \
            --base dev \
            --head $conflict_branch \
            --title "ðŸ”„ [ìžë™] Main â†’ Dev ë™ê¸°í™” (ì¶©ëŒ í•´ê²° í•„ìš”)" \
            --body-file pr_body.md \
            --label "sync,conflict,hotfix"
          
          echo "ðŸ“‹ ì¶©ëŒ í•´ê²° PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          rm -f pr_body.md

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ”„ ë¸Œëžœì¹˜ ë™ê¸°í™” ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "- **ì†ŒìŠ¤**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **íƒ€ê²Ÿ**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ë²¤íŠ¸**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì°¸ì¡°**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.ref_type }}" == "tag" ]; then
            echo "- **ìƒíƒœ**: â­ï¸ ìŠ¤í‚µë¨ (íƒœê·¸ ì´ë²¤íŠ¸ - ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check-sync.outputs.sync_needed }}" == "false" ]; then
            echo "- **ìƒíƒœ**: âœ… ì´ë¯¸ ìµœì‹  ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.auto-sync.outputs.sync_success }}" == "true" ]; then
            echo "- **ìƒíƒœ**: âœ… ìžë™ ë™ê¸°í™” ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.auto-sync.outputs.sync_success }}" == "false" ]; then
            echo "- **ìƒíƒœ**: âš ï¸ ì¶©ëŒ ê°ì§€ - ìˆ˜ë™ í•´ê²° PR ìƒì„±ë¨" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ìƒíƒœ**: âŒ ë™ê¸°í™” ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY 