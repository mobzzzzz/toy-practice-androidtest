name: Version Management

on:
  pull_request:
    types: [closed]
    branches: ["dev"]
  push:
    branches: ["main"]
    tags:
      - 'v*'

jobs:
  version-control:
    if: |
      (github.event.pull_request.merged == true && github.base_ref == 'dev') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    outputs:
      version_code: ${{ steps.version-update.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update Version Code
        if: github.event.pull_request.merged == true && github.base_ref == 'dev'  # dev로 머지될 때만 증가
        id: version-update
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        with:
          github-token: ${{ secrets.ADMIN_TOKEN }}
          script: |
            const currentVersion = parseInt('${{ vars.VERSION_CODE }}') || 0;
            const newVersion = currentVersion + 1;
            
            await github.rest.actions.updateRepoVariable({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'VERSION_CODE',
              value: newVersion.toString()
            });
            
            console.log(`Version Code updated: ${currentVersion} → ${newVersion}`);
            core.setOutput('new_version', newVersion.toString());

      - name: Version Update & Tag Creation
        if: github.event.pull_request.merged == true
        id: version
        run: |
          # 최신 태그 가져오기 (beta 또는 릴리즈)
          latest_tag=$(git tag -l "v*" --sort=-v:refname | head -n 1)
          
          if [[ "${{ github.base_ref }}" == "dev" ]]; then
            # beta 버전 생성을 위한 타임스탬프
            timestamp=$(date +%Y%m%d%H%M%S)
            
            if [ -z "$latest_tag" ]; then
              # 태그가 없는 경우 v1.0.0-beta.timestamp 생성
              new_version="v1.0.0-beta.$timestamp"
            else
              # 기존 버전에서 증가
              base_version=$(echo $latest_tag | sed 's/-beta\.[0-9]\+//' | sed 's/^v//')
              IFS='.' read -r major minor patch <<< "$base_version"
              
              case "${{ github.head_ref }}" in
                major/*)
                  new_version="v$((major + 1)).0.0-beta.$timestamp"
                  ;;
                feat/*)
                  new_version="v$major.$((minor + 1)).0-beta.$timestamp"
                  ;;
                fix/* | *)
                  new_version="v$major.$minor.$((patch + 1))-beta.$timestamp"
                  ;;
              esac
            fi
            
            echo "Creating beta tag: $new_version"
            git tag -a "$new_version" -m "Beta release $new_version"
            git push origin "$new_version"
            
          elif [[ "${{ github.base_ref }}" == "main" ]]; then
            # beta 태그에서 릴리즈 버전 추출
            latest_beta=$(git tag -l "v*-beta.*" --sort=-v:refname | head -n 1)
            release_version=$(echo $latest_beta | sed 's/-beta\.[0-9]\+//')
            
            echo "Creating release tag: $release_version"
            git tag -a "$release_version" -m "Release version $release_version"
            git push origin "$release_version"
          fi

  build:
    needs: version-control
    uses: ./.github/workflows/build.yml
    with:
      version_code: ${{ needs.version-control.outputs.version_code }}