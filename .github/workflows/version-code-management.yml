name: Android Version Code Management

on:
  # PR 머지 시에만 versionCode 업데이트 (더 안전한 접근)
  push:
    branches: ["dev", "main"]
  
  # PR 열릴 때는 검증만 수행
  pull_request:
    types: [opened, synchronize]
    branches: ["dev", "main"]

jobs:
  # PR 단계: versionCode 충돌 검증
  validate-version-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Version Code
        run: |
          # 현재 PR의 versionCode 확인
          pr_version=$(grep "versionCode = " app/build.gradle.kts | sed 's/.*= \([0-9]*\).*/\1/')
          
          # 타겟 브랜치의 versionCode 확인
          git fetch origin ${{ github.base_ref }}
          git show origin/${{ github.base_ref }}:app/build.gradle.kts > temp_build.gradle.kts
          base_version=$(grep "versionCode = " temp_build.gradle.kts | sed 's/.*= \([0-9]*\).*/\1/')
          
          echo "PR versionCode: $pr_version"
          echo "Base versionCode: $base_version"
          
          # versionCode가 감소했는지 확인
          if [ "$pr_version" -lt "$base_version" ]; then
            echo "❌ Error: versionCode cannot be decreased ($pr_version < $base_version)"
            exit 1
          fi
          
          # versionCode가 같은지 확인 (머지 시 충돌 가능성)
          if [ "$pr_version" -eq "$base_version" ]; then
            echo "⚠️ Warning: versionCode is same as base. Will be auto-incremented on merge."
          fi
          
          rm -f temp_build.gradle.kts

      - name: Comment PR Status
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // versionCode 정보 읽기
            const buildGradle = fs.readFileSync('app/build.gradle.kts', 'utf8');
            const versionMatch = buildGradle.match(/versionCode = (\d+)/);
            const currentVersion = versionMatch ? versionMatch[1] : 'unknown';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `📱 **Android Version Code Status**\n\n` +
                    `Current PR versionCode: \`${currentVersion}\`\n\n` +
                    `ℹ️ **Note**: Final versionCode will be automatically assigned when this PR is merged to ensure no conflicts with other concurrent PRs.`
            });

  # 머지 후: 실제 versionCode 업데이트
  update-version-on-merge:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Latest Version and Update
        id: version-update
        run: |
          current_version=$(grep "versionCode = " app/build.gradle.kts | sed 's/.*= \([0-9]*\).*/\1/')
          
          # 안전한 다음 버전 계산 (타임스탬프 기반 또는 단순 증가)
          # 방법 1: 단순 증가 (권장)
          new_version=$((current_version + 1))
          
          # 방법 2: 타임스탬프 기반 (충돌 방지)
          # timestamp_version=$(date +%s)
          # if [ $timestamp_version -le $current_version ]; then
          #   new_version=$((current_version + 1))
          # else
          #   new_version=$timestamp_version
          # fi
          
          echo "Current version: $current_version"
          echo "New version: $new_version"
          
          # versionCode 업데이트
          sed -i 's/versionCode = .*/versionCode = '$new_version'/' app/build.gradle.kts
          
          echo "current_version=$current_version" >> $GITHUB_OUTPUT
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          
          # 변경사항 확인
          if git diff --quiet app/build.gradle.kts; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit Version Update
        if: steps.version-update.outputs.changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add app/build.gradle.kts
          git commit -m "chore: auto-increment versionCode to ${{ steps.version-update.outputs.new_version }}

          Previous: ${{ steps.version-update.outputs.current_version }}
          New: ${{ steps.version-update.outputs.new_version }}
          
          [skip ci]"
          
          git push