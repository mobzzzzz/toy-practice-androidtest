name: Android Version Code Management

on:
  # PR ë¨¸ì§€ ì‹œì—ë§Œ versionCode ì—…ë°ì´íŠ¸
  push:
    branches: ["dev", "main"]
  
  # PR ì—´ë¦´ ë•ŒëŠ” ê²€ì¦ë§Œ ìˆ˜í–‰
  pull_request:
    types: [opened, synchronize]
    branches: ["dev", "main"]

jobs:
  # PR ë‹¨ê³„: versionCode ì¶©ëŒ ê²€ì¦
  validate-version-pr:
    name: "Validate Version PR"
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Version Code
        run: |
          # í˜„ì¬ PRì˜ versionCode í™•ì¸
          pr_version=$(grep "versionCode = " app/build.gradle.kts | sed 's/.*= \([0-9]*\).*/\1/')
          
          # íƒ€ê²Ÿ ë¸Œëœì¹˜ì˜ versionCode í™•ì¸
          git fetch origin ${{ github.base_ref }}
          git show origin/${{ github.base_ref }}:app/build.gradle.kts > temp_build.gradle.kts
          base_version=$(grep "versionCode = " temp_build.gradle.kts | sed 's/.*= \([0-9]*\).*/\1/')
          
          echo "PR versionCode: $pr_version"
          echo "Base versionCode: $base_version"
          
          # versionCodeê°€ ê°ì†Œí–ˆëŠ”ì§€ í™•ì¸
          if [ "$pr_version" -lt "$base_version" ]; then
            echo "âŒ ì˜¤ë¥˜: ë²„ì „ ì½”ë“œëŠ” ê°ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ($pr_version < $base_version)"
            exit 1
          fi
          
          # versionCodeê°€ ê°™ì€ì§€ í™•ì¸ (ë¨¸ì§€ ì‹œ ì¶©ëŒ ê°€ëŠ¥ì„±)
          if [ "$pr_version" -eq "$base_version" ]; then
            echo "âš ï¸ ì£¼ì˜: í˜„ì¬ ë²„ì „ì´ íƒ€ê²Ÿ ë¸Œëœì¹˜ì™€ ë™ì¼í•©ë‹ˆë‹¤. ë¨¸ì§€ ì‹œ ìë™ìœ¼ë¡œ ì¦ê°€ë©ë‹ˆë‹¤."
          fi

      - name: Comment PR Status
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
      
            const buildGradle = fs.readFileSync('app/build.gradle.kts', 'utf8');
            const versionMatch = buildGradle.match(/versionCode = (\d+)/);
            const currentVersion = versionMatch ? versionMatch[1] : 'í™•ì¸ ë¶ˆê°€';

            const message = [
              'ğŸ“± **ì•ˆë“œë¡œì´ë“œ ë²„ì „ ì½”ë“œ ìƒíƒœ**',
              '',
              `í˜„ì¬ PRì˜ ë²„ì „ ì½”ë“œ: \`${currentVersion}\``,
              '',
              'â„¹ï¸ **ì°¸ê³ **: ë‹¤ë¥¸ PRê³¼ì˜ ì¶©ëŒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ìµœì¢… ë²„ì „ ì½”ë“œëŠ” PR ë¨¸ì§€ ì‹œì ì— ìë™ìœ¼ë¡œ í• ë‹¹ë©ë‹ˆë‹¤.'
            ].join('\n');

            // ê¸°ì¡´ ë´‡ ëŒ“ê¸€ ì°¾ê¸°
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.data.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ“± **ì•ˆë“œë¡œì´ë“œ ë²„ì „ ì½”ë“œ ìƒíƒœ**')
            );

            if (botComment) {
              // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸ (ì•Œë¦¼ ì•ˆ ê°)
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: message
              });
            } else {
              // ìƒˆ ëŒ“ê¸€ ìƒì„±
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }

  # ë¨¸ì§€ í›„: ì‹¤ì œ versionCode ì—…ë°ì´íŠ¸
  update-version-on-merge:
    name: "Update Version on Merge"
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Latest Version and Update
        id: version-update
        run: |
          current_version=$(grep "versionCode = " app/build.gradle.kts | sed 's/.*= \([0-9]*\).*/\1/')
          
          # ì•ˆì „í•œ ë‹¤ìŒ ë²„ì „ ê³„ì‚° (íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ ë˜ëŠ” ë‹¨ìˆœ ì¦ê°€)
          # ë°©ë²• 1: ë‹¨ìˆœ ì¦ê°€ (ê¶Œì¥)
          new_version=$((current_version + 1))
          
          # ë°©ë²• 2: íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ (ì¶©ëŒ ë°©ì§€)
          # timestamp_version=$(date +%s)
          # if [ $timestamp_version -le $current_version ]; then
          #   new_version=$((current_version + 1))
          # else
          #   new_version=$timestamp_version
          # fi
          
          echo "Current version: $current_version"
          echo "New version: $new_version"
          
          # versionCode ì—…ë°ì´íŠ¸
          sed -i 's/versionCode = .*/versionCode = '$new_version'/' app/build.gradle.kts
          
          echo "current_version=$current_version" >> $GITHUB_OUTPUT
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --quiet app/build.gradle.kts; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit Version Update
        if: steps.version-update.outputs.changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add app/build.gradle.kts
          git commit -m "chore: ë²„ì „ ì½”ë“œ ìë™ ì¦ê°€ (${{ steps.version-update.outputs.new_version }})

          ì´ì „: ${{ steps.version-update.outputs.current_version }}
          í˜„ì¬: ${{ steps.version-update.outputs.new_version }}
          
          [skip ci]"
          
          git push