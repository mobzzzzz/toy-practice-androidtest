name: GitFlow ìë™ ë™ê¸°í™”

on:
  push:
    branches:
      - main
      - 'release/**'
  workflow_dispatch:
    inputs:
      sync_reason:
        description: 'ë™ê¸°í™” ì‹¤í–‰ ì´ìœ '
        required: true
        default: 'ìˆ˜ë™ ë™ê¸°í™” ìš”ì²­'

jobs:
  detect-gitflow-changes:
    name: GitFlow ë³€ê²½ì‚¬í•­ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      should_sync: ${{ steps.detect.outputs.should_sync }}
      sync_type: ${{ steps.detect.outputs.sync_type }}
      source_branch: ${{ steps.detect.outputs.source_branch }}
      sync_reason: ${{ steps.detect.outputs.sync_reason }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: GitFlow ë³€ê²½ì‚¬í•­ ê°ì§€
        id: detect
        run: |
          echo "ğŸ” GitFlow ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•©ë‹ˆë‹¤..."
          
          should_sync="false"
          sync_type=""
          source_branch=""
          sync_reason=""
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ğŸ“ ìˆ˜ë™ ì‹¤í–‰: ${{ github.event.inputs.sync_reason }}"
            should_sync="true"
            sync_type="manual"
            source_branch="main"
            sync_reason="${{ github.event.inputs.sync_reason }}"
          
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            current_branch="${{ github.ref_name }}"
            echo "ğŸ“¤ ë¸Œëœì¹˜ í‘¸ì‹œ ê°ì§€: $current_branch"
            
            if [[ "$current_branch" =~ ^release/ ]]; then
              echo "ğŸš€ Release ë¸Œëœì¹˜ì— ìƒˆ ì»¤ë°‹ ê°ì§€: $current_branch"
              should_sync="true"
              sync_type="release_commit"
              source_branch="$current_branch"
              sync_reason="Release $current_branch ì— ìƒˆ ì»¤ë°‹ ì¶”ê°€ë¨"
            elif [[ "$current_branch" == "main" ]]; then
              # main ë¸Œëœì¹˜ì—ì„œ ìµœê·¼ GitFlow ë¨¸ì§€ í™•ì¸
              recent_commits=$(git log --oneline -3 --grep="Merge.*hotfix\|Merge.*release" || echo "")
              if [[ -n "$recent_commits" ]]; then
                echo "ğŸ”„ GitFlow ë¨¸ì§€ ì»¤ë°‹ ê°ì§€:"
                echo "$recent_commits"
                should_sync="true"
                sync_type="main_push"
                source_branch="main"
                sync_reason="Main ë¸Œëœì¹˜ì— GitFlow ë¨¸ì§€ ì»¤ë°‹ ê°ì§€"
              fi
            fi
          fi
          
          echo "should_sync=$should_sync" >> $GITHUB_OUTPUT
          echo "sync_type=$sync_type" >> $GITHUB_OUTPUT
          echo "source_branch=$source_branch" >> $GITHUB_OUTPUT
          echo "sync_reason=$sync_reason" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ê°ì§€ ê²°ê³¼:"
          echo "  - ë™ê¸°í™” í•„ìš”: $should_sync"
          echo "  - ë™ê¸°í™” íƒ€ì…: $sync_type"
          echo "  - ì†ŒìŠ¤ ë¸Œëœì¹˜: $source_branch"
          echo "  - ë™ê¸°í™” ì´ìœ : $sync_reason"

  sync-to-dev:
    name: Dev ë¸Œëœì¹˜ ì•ˆì „ ë™ê¸°í™”
    runs-on: ubuntu-latest
    needs: detect-gitflow-changes
    if: needs.detect-gitflow-changes.outputs.should_sync == 'true'
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.ADMIN_TOKEN }}

      - name: Git ì„¤ì •
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ì•ˆì „í•œ Fast-forward ë™ê¸°í™”
        run: |
          echo "ğŸ”’ GitFlow ì•ˆì „ ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
          echo "ğŸ“‹ ë™ê¸°í™” ì •ë³´:"
          echo "  - íƒ€ì…: ${{ needs.detect-gitflow-changes.outputs.sync_type }}"
          echo "  - ì†ŒìŠ¤: ${{ needs.detect-gitflow-changes.outputs.source_branch }}"
          echo "  - ì´ìœ : ${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
          
          # ì›ê²© ë¸Œëœì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
          git fetch origin
          
          # Dev ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ
          if git show-ref --verify --quiet refs/remotes/origin/dev; then
            echo "ğŸ“¥ ê¸°ì¡´ dev ë¸Œëœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤..."
            git checkout -B dev origin/dev
          else
            echo "ğŸ†• ìƒˆë¡œìš´ dev ë¸Œëœì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
            git checkout -b dev
          fi
          
          # ì†ŒìŠ¤ ë¸Œëœì¹˜ ê²°ì •
          source_branch="${{ needs.detect-gitflow-changes.outputs.source_branch }}"
          
          echo "ğŸ¯ ë™ê¸°í™” ì†ŒìŠ¤: origin/$source_branch"
          
          # ì•ˆì „ì„± ê²€ì‚¬: devê°€ mainì˜ ì¡°ìƒì¸ì§€ í™•ì¸
          if git merge-base --is-ancestor "origin/$source_branch" HEAD; then
            echo "âœ… ì•ˆì „ì„± ê²€ì‚¬ í†µê³¼: devê°€ $source_branchë³´ë‹¤ ì•ì„œ ìˆìŠµë‹ˆë‹¤."
            echo "ğŸ“Š í˜„ì¬ ìƒíƒœ:"
            echo "  - $source_branch HEAD: $(git rev-parse --short origin/$source_branch)"
            echo "  - dev HEAD: $(git rev-parse --short HEAD)"
            echo ""
            echo "ğŸ” devì—ë§Œ ìˆëŠ” ì»¤ë°‹ë“¤ (feature ì‘ì—… ë“±):"
            git log --oneline "origin/$source_branch..HEAD" || echo "  (ì—†ìŒ)"
            echo ""
            echo "âš ï¸ Fast-forward ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤ (feature ì‘ì—… ë³´í˜¸)."
            echo "ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ $source_branchì˜ ë³€ê²½ì‚¬í•­ì„ devì— ë¨¸ì§€í•´ì£¼ì„¸ìš”."
            
          elif git merge-base --is-ancestor HEAD "origin/$source_branch"; then
            echo "âš¡ Fast-forward ë™ê¸°í™”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."
            echo "ğŸ“Š ë™ê¸°í™” ì „ ìƒíƒœ:"
            echo "  - dev HEAD: $(git rev-parse --short HEAD)"
            echo "  - $source_branch HEAD: $(git rev-parse --short origin/$source_branch)"
            
            # Fast-forward ë¨¸ì§€ ì‹¤í–‰
            git merge "origin/$source_branch" --ff-only
            
            echo "âœ… Fast-forward ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ“Š ë™ê¸°í™” í›„ ìƒíƒœ:"
            echo "  - dev HEAD: $(git rev-parse --short HEAD)"
            echo "  - ê²°ê³¼: Fast-forward (merge ì»¤ë°‹ ì—†ìŒ)"
            
          else
            echo "ğŸš¨ ë¸Œëœì¹˜ê°€ ë¶„ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ“Š í˜„ì¬ ìƒíƒœ:"
            echo "  - dev HEAD: $(git rev-parse --short HEAD)"
            echo "  - $source_branch HEAD: $(git rev-parse --short origin/$source_branch)"
            echo ""
            echo "ğŸ” devì—ë§Œ ìˆëŠ” ì»¤ë°‹ë“¤:"
            git log --oneline "origin/$source_branch..HEAD" || echo "  (ì—†ìŒ)"
            echo ""
            echo "ğŸ” $source_branchì—ë§Œ ìˆëŠ” ì»¤ë°‹ë“¤:"
            git log --oneline "HEAD..origin/$source_branch" || echo "  (ì—†ìŒ)"
            echo ""
            echo "âš ï¸ ìë™ ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤ (ë°ì´í„° ì†ì‹¤ ë°©ì§€)."
            echo "ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ ë¸Œëœì¹˜ë¥¼ ë¨¸ì§€í•´ì£¼ì„¸ìš”."
            
            # ë™ê¸°í™” ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
            echo "ğŸ”’ ì•ˆì „ì„±ì„ ìœ„í•´ ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

      - name: Dev ë¸Œëœì¹˜ í‘¸ì‹œ
        run: |
          # Fast-forwardê°€ ì‹¤ì œë¡œ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸
          if git diff --quiet HEAD@{1} HEAD 2>/dev/null; then
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ í‘¸ì‹œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          else
            echo "ğŸ“¤ dev ë¸Œëœì¹˜ë¥¼ ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œí•©ë‹ˆë‹¤..."
            git push origin dev
            echo "âœ… í‘¸ì‹œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          fi

      - name: ë™ê¸°í™” ê²°ê³¼ ì•Œë¦¼
        run: |
          echo "ğŸ‰ GitFlow ì•ˆì „ ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ğŸ“‹ ë™ê¸°í™” ìš”ì•½:"
          echo "  - íƒ€ì…: ${{ needs.detect-gitflow-changes.outputs.sync_type }}"
          echo "  - ì†ŒìŠ¤: ${{ needs.detect-gitflow-changes.outputs.source_branch }}"
          echo "  - ëŒ€ìƒ: dev ë¸Œëœì¹˜"
          echo "  - ì´ìœ : ${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
          echo "  - ë°©ì‹: ì•ˆì „í•œ Fast-forward (feature ì‘ì—… ë³´í˜¸)"
          echo ""
          echo "ğŸ”— ë¸Œëœì¹˜ ìƒíƒœ:"
          echo "  - dev HEAD: $(git rev-parse --short HEAD)" 