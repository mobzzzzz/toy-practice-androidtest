name: GitFlow ìžë™ ë™ê¸°í™”

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      sync_reason:
        description: 'ë™ê¸°í™” ì‹¤í–‰ ì´ìœ '
        required: true
        default: 'ìˆ˜ë™ ë™ê¸°í™” ìš”ì²­'

jobs:
  detect-gitflow-changes:
    name: ðŸ” GitFlow ë³€ê²½ì‚¬í•­ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      should_sync: ${{ steps.detect.outputs.should_sync }}
      sync_type: ${{ steps.detect.outputs.sync_type }}
      source_branch: ${{ steps.detect.outputs.source_branch }}
      sync_reason: ${{ steps.detect.outputs.sync_reason }}
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” GitFlow ë³€ê²½ì‚¬í•­ ê°ì§€
        id: detect
        run: |
          echo "ðŸ” GitFlow ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•©ë‹ˆë‹¤..."
          
          should_sync="false"
          sync_type=""
          source_branch=""
          sync_reason=""
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ðŸ“ ìˆ˜ë™ ì‹¤í–‰: ${{ github.event.inputs.sync_reason }}"
            should_sync="true"
            sync_type="manual"
            source_branch="main"
            sync_reason="${{ github.event.inputs.sync_reason }}"
          
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            pr_branch="${{ github.event.pull_request.head.ref }}"
            echo "ðŸ”€ PR ë¨¸ì§€ ê°ì§€: $pr_branch â†’ main"
            
            if [[ "$pr_branch" =~ ^hotfix/ ]]; then
              echo "ðŸš¨ Hotfix ë¸Œëžœì¹˜ ë¨¸ì§€ ê°ì§€: $pr_branch"
              should_sync="true"
              sync_type="hotfix"
              source_branch="$pr_branch"
              sync_reason="Hotfix $pr_branch ë¥¼ devì— ë™ê¸°í™”"
            
            elif [[ "$pr_branch" =~ ^release/ ]]; then
              echo "ðŸš€ Release ë¸Œëžœì¹˜ ë¨¸ì§€ ê°ì§€: $pr_branch"
              should_sync="true"
              sync_type="release"
              source_branch="$pr_branch"
              sync_reason="Release $pr_branch ë¥¼ devì— ë™ê¸°í™”"
            fi
          
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            current_branch="${{ github.ref_name }}"
            echo "ðŸ“¤ ë¸Œëžœì¹˜ í‘¸ì‹œ ê°ì§€: $current_branch"
            
            if [[ "$current_branch" =~ ^release/ ]]; then
              echo "ðŸš€ Release ë¸Œëžœì¹˜ì— ìƒˆ ì»¤ë°‹ ê°ì§€: $current_branch"
              should_sync="true"
              sync_type="release_commit"
              source_branch="$current_branch"
              sync_reason="Release $current_branch ì— ìƒˆ ì»¤ë°‹ ì¶”ê°€ë¨"
            elif [[ "$current_branch" == "main" ]]; then
              # main ë¸Œëžœì¹˜ì—ì„œ ìµœê·¼ GitFlow ë¨¸ì§€ í™•ì¸
              recent_commits=$(git log --oneline -3 --grep="Merge.*hotfix\|Merge.*release" || echo "")
              if [[ -n "$recent_commits" ]]; then
                echo "ðŸ”„ GitFlow ë¨¸ì§€ ì»¤ë°‹ ê°ì§€:"
                echo "$recent_commits"
                
                # ê°€ìž¥ ìµœê·¼ ë¨¸ì§€ëœ ë¸Œëžœì¹˜ ì°¾ê¸°
                latest_merge=$(git log --oneline -1 --grep="Merge.*hotfix\|Merge.*release" --format="%s" || echo "")
                if [[ "$latest_merge" =~ hotfix/([^[:space:]]+) ]]; then
                  merged_branch="hotfix/${BASH_REMATCH[1]}"
                  sync_type="hotfix_merged"
                elif [[ "$latest_merge" =~ release/([^[:space:]]+) ]]; then
                  merged_branch="release/${BASH_REMATCH[1]}"
                  sync_type="release_merged"
                fi
                
                if [[ -n "$merged_branch" ]]; then
                  should_sync="true"
                  source_branch="$merged_branch"
                  sync_reason="$merged_branch ê°€ mainì— ë¨¸ì§€ë˜ì–´ devì— ë™ê¸°í™”"
                fi
              fi
            fi
          fi
          
          echo "should_sync=$should_sync" >> $GITHUB_OUTPUT
          echo "sync_type=$sync_type" >> $GITHUB_OUTPUT
          echo "source_branch=$source_branch" >> $GITHUB_OUTPUT
          echo "sync_reason=$sync_reason" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š ê°ì§€ ê²°ê³¼:"
          echo "  - ë™ê¸°í™” í•„ìš”: $should_sync"
          echo "  - ë™ê¸°í™” íƒ€ìž…: $sync_type"
          echo "  - ì†ŒìŠ¤ ë¸Œëžœì¹˜: $source_branch"
          echo "  - ë™ê¸°í™” ì´ìœ : $sync_reason"

  sync-to-dev:
    name: ðŸ”„ Dev ë¸Œëžœì¹˜ ë™ê¸°í™”
    runs-on: ubuntu-latest
    needs: detect-gitflow-changes
    if: needs.detect-gitflow-changes.outputs.should_sync == 'true'
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.ADMIN_TOKEN }}

      - name: âš™ï¸ Git ì„¤ì •
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ”„ Dev ë¸Œëžœì¹˜ ë™ê¸°í™”
        run: |
          echo "ðŸ”„ GitFlow ìžë™ ë™ê¸°í™”ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          echo "ðŸ“‹ ë™ê¸°í™” ì •ë³´:"
          echo "  - íƒ€ìž…: ${{ needs.detect-gitflow-changes.outputs.sync_type }}"
          echo "  - ì†ŒìŠ¤: ${{ needs.detect-gitflow-changes.outputs.source_branch }}"
          echo "  - ì´ìœ : ${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
          
          # ì›ê²© ë¸Œëžœì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
          git fetch origin
          
          # Dev ë¸Œëžœì¹˜ ì²´í¬ì•„ì›ƒ
          if git show-ref --verify --quiet refs/remotes/origin/dev; then
            echo "ðŸ“¥ ê¸°ì¡´ dev ë¸Œëžœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤..."
            git checkout -B dev origin/dev
          else
            echo "ðŸ†• ìƒˆë¡œìš´ dev ë¸Œëžœì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
            git checkout -b dev
          fi
          
          # ì†ŒìŠ¤ ë¸Œëžœì¹˜ ê²°ì •
          source_branch="${{ needs.detect-gitflow-changes.outputs.source_branch }}"
          sync_type="${{ needs.detect-gitflow-changes.outputs.sync_type }}"
          
          echo "ðŸ”€ $source_branch ë¸Œëžœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ devì— ë¨¸ì§€í•©ë‹ˆë‹¤..."
          
          # ì†ŒìŠ¤ ë¸Œëžœì¹˜ê°€ ì›ê²©ì— ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
          if [[ "$sync_type" == "manual" ]]; then
            # ìˆ˜ë™ ì‹¤í–‰ì˜ ê²½ìš° main ë¸Œëžœì¹˜ ì‚¬ìš©
            merge_source="origin/main"
          elif git show-ref --verify --quiet "refs/remotes/origin/$source_branch"; then
            # ì›ê²© ë¸Œëžœì¹˜ê°€ ì¡´ìž¬í•˜ëŠ” ê²½ìš°
            merge_source="origin/$source_branch"
          elif [[ "$sync_type" =~ _merged$ ]]; then
            # ì´ë¯¸ ë¨¸ì§€ëœ ë¸Œëžœì¹˜ì˜ ê²½ìš° mainì—ì„œ í•´ë‹¹ ì»¤ë°‹ ì°¾ê¸°
            echo "ðŸ” main ë¸Œëžœì¹˜ì—ì„œ $source_branch ë¨¸ì§€ ì»¤ë°‹ì„ ì°¾ìŠµë‹ˆë‹¤..."
            merge_commit=$(git log --oneline -10 --grep="Merge.*$source_branch" --format="%H" | head -1)
            if [[ -n "$merge_commit" ]]; then
              merge_source="$merge_commit"
              echo "ðŸ“ ë¨¸ì§€ ì»¤ë°‹ ë°œê²¬: $merge_commit"
            else
              echo "âš ï¸ ë¨¸ì§€ ì»¤ë°‹ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ main ë¸Œëžœì¹˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
              merge_source="origin/main"
            fi
          else
            echo "âš ï¸ ì†ŒìŠ¤ ë¸Œëžœì¹˜ $source_branch ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ main ë¸Œëžœì¹˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
            merge_source="origin/main"
          fi
          
          echo "ðŸŽ¯ ë¨¸ì§€ ì†ŒìŠ¤: $merge_source"
          
          # Fast-forward ê°€ëŠ¥í•œì§€ í™•ì¸ (ì»¤ë°‹ í•´ì‹œê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
          if [[ "$merge_source" =~ ^[0-9a-f]{40}$ ]]; then
            # ì»¤ë°‹ í•´ì‹œì¸ ê²½ìš° ì§ì ‘ ë¨¸ì§€
            echo "ðŸ”€ ì»¤ë°‹ ë¨¸ì§€ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            
            sync_reason="${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
            event_name="${{ github.event_name }}"
            current_time=$(date '+%Y-%m-%d %H:%M:%S KST')
            
            commit_msg="sync: GitFlow ë™ê¸°í™” - ${sync_reason} (íŠ¸ë¦¬ê±°: ${event_name}, ì‹œê°„: ${current_time})"
            
            if git merge "$merge_source" --no-ff -m "$commit_msg"; then
              merge_result="merge"
            else
              echo "âŒ ìžë™ ë¨¸ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              merge_result="conflict"
            fi
          elif git merge-base --is-ancestor origin/dev "$merge_source"; then
            echo "âš¡ Fast-forward ë¨¸ì§€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."
            git merge "$merge_source" --ff-only
            merge_result="fast-forward"
          else
            echo "ðŸ”€ ì¼ë°˜ ë¨¸ì§€ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            
            sync_reason="${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
            event_name="${{ github.event_name }}"
            current_time=$(date '+%Y-%m-%d %H:%M:%S KST')
            
            commit_msg="sync: GitFlow ë™ê¸°í™” - ${sync_reason} (íŠ¸ë¦¬ê±°: ${event_name}, ì‹œê°„: ${current_time})"
            
            if git merge "$merge_source" --no-ff -m "$commit_msg"; then
              merge_result="merge"
            else
              echo "âŒ ìžë™ ë¨¸ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              merge_result="conflict"
            fi
          fi
          
          if [[ "$merge_result" == "conflict" ]]; then
            echo "ðŸš¨ ì¶©ëŒ í•´ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤!"
            echo "::error::GitFlow ë™ê¸°í™” ì¤‘ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ í•´ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ($merge_result)"

      - name: ðŸ“¤ Dev ë¸Œëžœì¹˜ í‘¸ì‹œ
        run: |
          echo "ðŸ“¤ dev ë¸Œëžœì¹˜ë¥¼ ì›ê²© ì €ìž¥ì†Œì— í‘¸ì‹œí•©ë‹ˆë‹¤..."
          git push origin dev
          echo "âœ… í‘¸ì‹œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: ðŸ“Š ë™ê¸°í™” ê²°ê³¼ ì•Œë¦¼
        run: |
          echo "ðŸŽ‰ GitFlow ìžë™ ë™ê¸°í™”ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ðŸ“‹ ë™ê¸°í™” ìš”ì•½:"
          echo "  - íƒ€ìž…: ${{ needs.detect-gitflow-changes.outputs.sync_type }}"
          echo "  - ì†ŒìŠ¤: ${{ needs.detect-gitflow-changes.outputs.source_branch }}"
          echo "  - ëŒ€ìƒ: dev ë¸Œëžœì¹˜"
          echo "  - ì´ìœ : ${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
          echo ""
          echo "ðŸ”— ë¸Œëžœì¹˜ ìƒíƒœ:"
          echo "  - ì†ŒìŠ¤: $(git rev-parse --short ${{ needs.detect-gitflow-changes.outputs.source_branch }} 2>/dev/null || echo 'N/A')"
          echo "  - dev:  $(git rev-parse --short HEAD)" name: ðŸ”„ GitFlow ìžë™ ë™ê¸°í™”

on:
  push:
    branches:
      - main
      - 'release/**'
    paths-ignore:
      - '.github/workflows/**'
      - 'docs/**'
      - '*.md'
      - '.cursorrules'
      - '.cursor/**'
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      sync_reason:
        description: 'ë™ê¸°í™” ì‹¤í–‰ ì´ìœ '
        required: true
        default: 'ìˆ˜ë™ ë™ê¸°í™” ìš”ì²­'

jobs:
  detect-gitflow-changes:
    name: ðŸ” GitFlow ë³€ê²½ì‚¬í•­ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      should_sync: ${{ steps.detect.outputs.should_sync }}
      sync_type: ${{ steps.detect.outputs.sync_type }}
      source_branch: ${{ steps.detect.outputs.source_branch }}
      sync_reason: ${{ steps.detect.outputs.sync_reason }}
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” GitFlow ë³€ê²½ì‚¬í•­ ê°ì§€
        id: detect
        run: |
          echo "ðŸ” GitFlow ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•©ë‹ˆë‹¤..."
          
          should_sync="false"
          sync_type=""
          source_branch=""
          sync_reason=""
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ðŸ“ ìˆ˜ë™ ì‹¤í–‰: ${{ github.event.inputs.sync_reason }}"
            should_sync="true"
            sync_type="manual"
            source_branch="main"
            sync_reason="${{ github.event.inputs.sync_reason }}"
          
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            pr_branch="${{ github.event.pull_request.head.ref }}"
            echo "ðŸ”€ PR ë¨¸ì§€ ê°ì§€: $pr_branch â†’ main"
            
            if [[ "$pr_branch" =~ ^hotfix/ ]]; then
              echo "ðŸš¨ Hotfix ë¸Œëžœì¹˜ ë¨¸ì§€ ê°ì§€: $pr_branch"
              should_sync="true"
              sync_type="hotfix"
              source_branch="$pr_branch"
              sync_reason="Hotfix $pr_branch ë¥¼ devì— ë™ê¸°í™”"
            
            elif [[ "$pr_branch" =~ ^release/ ]]; then
              echo "ðŸš€ Release ë¸Œëžœì¹˜ ë¨¸ì§€ ê°ì§€: $pr_branch"
              should_sync="true"
              sync_type="release"
              source_branch="$pr_branch"
              sync_reason="Release $pr_branch ë¥¼ devì— ë™ê¸°í™”"
            fi
          
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            current_branch="${{ github.ref_name }}"
            echo "ðŸ“¤ ë¸Œëžœì¹˜ í‘¸ì‹œ ê°ì§€: $current_branch"
            
            if [[ "$current_branch" =~ ^release/ ]]; then
              echo "ðŸš€ Release ë¸Œëžœì¹˜ì— ìƒˆ ì»¤ë°‹ ê°ì§€: $current_branch"
              should_sync="true"
              sync_type="release_commit"
              source_branch="$current_branch"
              sync_reason="Release $current_branch ì— ìƒˆ ì»¤ë°‹ ì¶”ê°€ë¨"
            elif [[ "$current_branch" == "main" ]]; then
              # main ë¸Œëžœì¹˜ì—ì„œ ìµœê·¼ GitFlow ë¨¸ì§€ í™•ì¸
              recent_commits=$(git log --oneline -3 --grep="Merge.*hotfix\|Merge.*release" || echo "")
              if [[ -n "$recent_commits" ]]; then
                echo "ðŸ”„ GitFlow ë¨¸ì§€ ì»¤ë°‹ ê°ì§€:"
                echo "$recent_commits"
                
                # ê°€ìž¥ ìµœê·¼ ë¨¸ì§€ëœ ë¸Œëžœì¹˜ ì°¾ê¸°
                latest_merge=$(git log --oneline -1 --grep="Merge.*hotfix\|Merge.*release" --format="%s" || echo "")
                if [[ "$latest_merge" =~ hotfix/([^[:space:]]+) ]]; then
                  merged_branch="hotfix/${BASH_REMATCH[1]}"
                  sync_type="hotfix_merged"
                elif [[ "$latest_merge" =~ release/([^[:space:]]+) ]]; then
                  merged_branch="release/${BASH_REMATCH[1]}"
                  sync_type="release_merged"
                fi
                
                if [[ -n "$merged_branch" ]]; then
                  should_sync="true"
                  source_branch="$merged_branch"
                  sync_reason="$merged_branch ê°€ mainì— ë¨¸ì§€ë˜ì–´ devì— ë™ê¸°í™”"
                fi
              fi
            fi
          fi
          
          echo "should_sync=$should_sync" >> $GITHUB_OUTPUT
          echo "sync_type=$sync_type" >> $GITHUB_OUTPUT
          echo "source_branch=$source_branch" >> $GITHUB_OUTPUT
          echo "sync_reason=$sync_reason" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š ê°ì§€ ê²°ê³¼:"
          echo "  - ë™ê¸°í™” í•„ìš”: $should_sync"
          echo "  - ë™ê¸°í™” íƒ€ìž…: $sync_type"
          echo "  - ì†ŒìŠ¤ ë¸Œëžœì¹˜: $source_branch"
          echo "  - ë™ê¸°í™” ì´ìœ : $sync_reason"

  sync-to-dev:
    name: ðŸ”„ Dev ë¸Œëžœì¹˜ ë™ê¸°í™”
    runs-on: ubuntu-latest
    needs: detect-gitflow-changes
    if: needs.detect-gitflow-changes.outputs.should_sync == 'true'
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Git ì„¤ì •
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ”„ Dev ë¸Œëžœì¹˜ ë™ê¸°í™”
        run: |
          echo "ðŸ”„ GitFlow ìžë™ ë™ê¸°í™”ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          echo "ðŸ“‹ ë™ê¸°í™” ì •ë³´:"
          echo "  - íƒ€ìž…: ${{ needs.detect-gitflow-changes.outputs.sync_type }}"
          echo "  - ì†ŒìŠ¤: ${{ needs.detect-gitflow-changes.outputs.source_branch }}"
          echo "  - ì´ìœ : ${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
          
          # ì›ê²© ë¸Œëžœì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
          git fetch origin
          
          # Dev ë¸Œëžœì¹˜ ì²´í¬ì•„ì›ƒ
          if git show-ref --verify --quiet refs/remotes/origin/dev; then
            echo "ðŸ“¥ ê¸°ì¡´ dev ë¸Œëžœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤..."
            git checkout -B dev origin/dev
          else
            echo "ðŸ†• ìƒˆë¡œìš´ dev ë¸Œëžœì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
            git checkout -b dev
          fi
          
          # ì†ŒìŠ¤ ë¸Œëžœì¹˜ ê²°ì •
          source_branch="${{ needs.detect-gitflow-changes.outputs.source_branch }}"
          sync_type="${{ needs.detect-gitflow-changes.outputs.sync_type }}"
          
          echo "ðŸ”€ $source_branch ë¸Œëžœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ devì— ë¨¸ì§€í•©ë‹ˆë‹¤..."
          
          # ì†ŒìŠ¤ ë¸Œëžœì¹˜ê°€ ì›ê²©ì— ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
          if [[ "$sync_type" == "manual" ]]; then
            # ìˆ˜ë™ ì‹¤í–‰ì˜ ê²½ìš° main ë¸Œëžœì¹˜ ì‚¬ìš©
            merge_source="origin/main"
          elif git show-ref --verify --quiet "refs/remotes/origin/$source_branch"; then
            # ì›ê²© ë¸Œëžœì¹˜ê°€ ì¡´ìž¬í•˜ëŠ” ê²½ìš°
            merge_source="origin/$source_branch"
          elif [[ "$sync_type" =~ _merged$ ]]; then
            # ì´ë¯¸ ë¨¸ì§€ëœ ë¸Œëžœì¹˜ì˜ ê²½ìš° mainì—ì„œ í•´ë‹¹ ì»¤ë°‹ ì°¾ê¸°
            echo "ðŸ” main ë¸Œëžœì¹˜ì—ì„œ $source_branch ë¨¸ì§€ ì»¤ë°‹ì„ ì°¾ìŠµë‹ˆë‹¤..."
            merge_commit=$(git log --oneline -10 --grep="Merge.*$source_branch" --format="%H" | head -1)
            if [[ -n "$merge_commit" ]]; then
              merge_source="$merge_commit"
              echo "ðŸ“ ë¨¸ì§€ ì»¤ë°‹ ë°œê²¬: $merge_commit"
            else
              echo "âš ï¸ ë¨¸ì§€ ì»¤ë°‹ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ main ë¸Œëžœì¹˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
              merge_source="origin/main"
            fi
          else
            echo "âš ï¸ ì†ŒìŠ¤ ë¸Œëžœì¹˜ $source_branch ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ main ë¸Œëžœì¹˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
            merge_source="origin/main"
          fi
          
          echo "ðŸŽ¯ ë¨¸ì§€ ì†ŒìŠ¤: $merge_source"
          
          # Fast-forward ê°€ëŠ¥í•œì§€ í™•ì¸ (ì»¤ë°‹ í•´ì‹œê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
          if [[ "$merge_source" =~ ^[0-9a-f]{40}$ ]]; then
            # ì»¤ë°‹ í•´ì‹œì¸ ê²½ìš° ì§ì ‘ ë¨¸ì§€
            echo "ðŸ”€ ì»¤ë°‹ ë¨¸ì§€ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            
            sync_reason="${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
            event_name="${{ github.event_name }}"
            current_time=$(date '+%Y-%m-%d %H:%M:%S KST')
            
            commit_msg="sync: GitFlow ë™ê¸°í™” - ${sync_reason} (íŠ¸ë¦¬ê±°: ${event_name}, ì‹œê°„: ${current_time})"
            
            if git merge "$merge_source" --no-ff -m "$commit_msg"; then
              merge_result="merge"
            else
              echo "âŒ ìžë™ ë¨¸ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              merge_result="conflict"
            fi
          elif git merge-base --is-ancestor origin/dev "$merge_source"; then
            echo "âš¡ Fast-forward ë¨¸ì§€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."
            git merge "$merge_source" --ff-only
            merge_result="fast-forward"
          else
            echo "ðŸ”€ ì¼ë°˜ ë¨¸ì§€ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            
            sync_reason="${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
            event_name="${{ github.event_name }}"
            current_time=$(date '+%Y-%m-%d %H:%M:%S KST')
            
            commit_msg="sync: GitFlow ë™ê¸°í™” - ${sync_reason} (íŠ¸ë¦¬ê±°: ${event_name}, ì‹œê°„: ${current_time})"
            
            if git merge "$merge_source" --no-ff -m "$commit_msg"; then
              merge_result="merge"
            else
              echo "âŒ ìžë™ ë¨¸ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              merge_result="conflict"
            fi
          fi
          
          if [[ "$merge_result" == "conflict" ]]; then
            echo "ðŸš¨ ì¶©ëŒ í•´ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤!"
            echo "::error::GitFlow ë™ê¸°í™” ì¤‘ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ í•´ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ($merge_result)"

      - name: ðŸ“¤ Dev ë¸Œëžœì¹˜ í‘¸ì‹œ
        run: |
          echo "ðŸ“¤ dev ë¸Œëžœì¹˜ë¥¼ ì›ê²© ì €ìž¥ì†Œì— í‘¸ì‹œí•©ë‹ˆë‹¤..."
          git push origin dev
          echo "âœ… í‘¸ì‹œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: ðŸ“Š ë™ê¸°í™” ê²°ê³¼ ì•Œë¦¼
        run: |
          echo "ðŸŽ‰ GitFlow ìžë™ ë™ê¸°í™”ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ðŸ“‹ ë™ê¸°í™” ìš”ì•½:"
          echo "  - íƒ€ìž…: ${{ needs.detect-gitflow-changes.outputs.sync_type }}"
          echo "  - ì†ŒìŠ¤: ${{ needs.detect-gitflow-changes.outputs.source_branch }}"
          echo "  - ëŒ€ìƒ: dev ë¸Œëžœì¹˜"
          echo "  - ì´ìœ : ${{ needs.detect-gitflow-changes.outputs.sync_reason }}"
          echo ""
          echo "ðŸ”— ë¸Œëžœì¹˜ ìƒíƒœ:"
          echo "  - ì†ŒìŠ¤: $(git rev-parse --short ${{ needs.detect-gitflow-changes.outputs.source_branch }} 2>/dev/null || echo 'N/A')"
          echo "  - dev:  $(git rev-parse --short HEAD)" 