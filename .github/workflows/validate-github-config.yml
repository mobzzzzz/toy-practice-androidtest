name: Validate GitHub Configuration

on:
  workflow_call:

jobs:
  validate-github-config:
    name: Validate GitHub Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Check VERSION_CODE Variable
        run: |
          if [ -z "${{ vars.VERSION_CODE }}" ]; then
            echo "âŒ ERROR: VERSION_CODE ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo ""
            echo "ğŸ”§ í•´ê²° ë°©ë²•:"
            echo "1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Variables íƒ­ í´ë¦­"
            echo "3. 'New repository variable' í´ë¦­"
            echo "4. Name: VERSION_CODE, Value: 1 ì…ë ¥"
            echo "5. 'Add variable' í´ë¦­"
            echo ""
            echo "ğŸ“š ìì„¸í•œ ê°€ì´ë“œ: docs/GITHUB_SETUP_GUIDE.md"
            exit 1
          else
            echo "âœ… VERSION_CODE ë³€ìˆ˜ í™•ì¸ë¨: ${{ vars.VERSION_CODE }}"
          fi

      - name: Check GitHub App Secrets
        run: |
          if [ -z "${{ secrets.APP_ID }}" ]; then
            echo "âŒ ERROR: APP_ID ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo ""
            echo "ğŸ”§ í•´ê²° ë°©ë²•:"
            echo "1. GitHub â†’ Settings â†’ Developer settings â†’ GitHub Apps"
            echo "2. 'New GitHub App' í´ë¦­í•˜ì—¬ ì•± ìƒì„±"
            echo "3. ë‹¤ìŒ ê¶Œí•œ ì„¤ì •:"
            echo "   - âœ… Actions: Write (ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°)"
            echo "   - âœ… Contents: Write (ì½”ë“œ í‘¸ì‹œ)"
            echo "   - âœ… Metadata: Read (ê¸°ë³¸ ì •ë³´ ì½ê¸°)"
            echo "   - âœ… Variables: Write (VERSION_CODE ì—…ë°ì´íŠ¸)"
            echo "   - âœ… Pull requests: Write (PR ìƒì„±)"
            echo "4. ì•±ì„ ë¦¬í¬ì§€í† ë¦¬ì— ì„¤ì¹˜"
            echo "5. Repository â†’ Settings â†’ Secrets and variables â†’ Actions â†’ Secrets"
            echo "6. 'New repository secret' í´ë¦­"
            echo "7. Name: APP_ID, Secret: GitHub App ID ì…ë ¥"
            echo ""
            echo "ğŸ“š ìì„¸í•œ ê°€ì´ë“œ: docs/GITHUB_SETUP_GUIDE.md"
            exit 1
          else
            echo "âœ… APP_ID ì‹œí¬ë¦¿ í™•ì¸ë¨"
          fi

          if [ -z "${{ secrets.APP_PRIVATE_KEY }}" ]; then
            echo "âŒ ERROR: APP_PRIVATE_KEY ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo ""
            echo "ğŸ”§ í•´ê²° ë°©ë²•:"
            echo "1. GitHub App ì„¤ì • í˜ì´ì§€ì—ì„œ 'Generate a private key' í´ë¦­"
            echo "2. ë‹¤ìš´ë¡œë“œëœ .pem íŒŒì¼ ë‚´ìš© ë³µì‚¬"
            echo "3. Repository â†’ Settings â†’ Secrets and variables â†’ Actions â†’ Secrets"
            echo "4. 'New repository secret' í´ë¦­"
            echo "5. Name: APP_PRIVATE_KEY, Secret: .pem íŒŒì¼ ì „ì²´ ë‚´ìš© ì…ë ¥"
            echo ""
            echo "ğŸ“š ìì„¸í•œ ê°€ì´ë“œ: docs/GITHUB_SETUP_GUIDE.md"
            exit 1
          else
            echo "âœ… APP_PRIVATE_KEY ì‹œí¬ë¦¿ í™•ì¸ë¨"
          fi

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Test GitHub App Token Permissions
        run: |
          echo "ğŸ” GitHub App í† í° ê¶Œí•œ í…ŒìŠ¤íŠ¸ ì¤‘..."
          
          # GitHub APIë¡œ ê¶Œí•œ í…ŒìŠ¤íŠ¸
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}")
          
          http_code=$(echo "$response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… GitHub App í† í° ê¶Œí•œ í™•ì¸ë¨"
          elif [ "$http_code" = "401" ]; then
            echo "âŒ ERROR: GitHub App í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            echo ""
            echo "ğŸ”§ í•´ê²° ë°©ë²•:"
            echo "1. APP_IDì™€ APP_PRIVATE_KEYê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸"
            echo "2. GitHub Appì´ ë¦¬í¬ì§€í† ë¦¬ì— ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸"
            echo "3. Private keyê°€ ë§Œë£Œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸"
            echo ""
            echo "ğŸ“š ìì„¸í•œ ê°€ì´ë“œ: docs/GITHUB_SETUP_GUIDE.md"
            exit 1
          elif [ "$http_code" = "403" ]; then
            echo "âŒ ERROR: GitHub App ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤!"
            echo ""
            echo "ğŸ”§ í•´ê²° ë°©ë²•:"
            echo "1. GitHub App ì„¤ì •ì—ì„œ ë‹¤ìŒ ê¶Œí•œ í™•ì¸:"
            echo "   - âœ… Actions: Write (ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°)"
            echo "   - âœ… Contents: Write (ì½”ë“œ í‘¸ì‹œ)"
            echo "   - âœ… Metadata: Read (ê¸°ë³¸ ì •ë³´ ì½ê¸°)"
            echo "   - âœ… Variables: Write (VERSION_CODE ì—…ë°ì´íŠ¸)"
            echo "   - âœ… Pull requests: Write (PR ìƒì„±)"
            echo "2. ê¶Œí•œ ë³€ê²½ í›„ ì•±ì„ ë¦¬í¬ì§€í† ë¦¬ì— ì¬ì„¤ì¹˜"
            echo ""
            echo "ğŸ“š ìì„¸í•œ ê°€ì´ë“œ: docs/GITHUB_SETUP_GUIDE.md"
            exit 1
          else
            echo "âš ï¸ WARNING: GitHub API ì‘ë‹µ ì½”ë“œ: $http_code"
            echo "ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì´ê±°ë‚˜ GitHub ì„œë¹„ìŠ¤ ì¥ì• ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            echo "GitHub Status í™•ì¸: https://www.githubstatus.com/"
          fi 